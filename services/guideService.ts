import { UserSelection, GuideContent } from '../types';

export const getGuideContent = (selection: UserSelection): GuideContent => {
  const { target, position, violenceType, status } = selection;

  // Default fallback
  const guide: GuideContent = {
    title: "맞춤형 행동 가이드",
    summary: "선택하신 상황에 맞는 기본적인 대처 방법을 안내해 드립니다.",
    actions: ["안전을 먼저 확보하세요.", "신뢰할 수 있는 사람에게 도움을 요청하세요."],
    legalBasis: "학교폭력예방 및 대책에 관한 법률",
    contacts: [
      { name: "학교폭력 신고센터", phone: "117", desc: "24시간 상담 및 신고" },
      { name: "청소년 전화", phone: "1388", desc: "심리 상담 및 위기 지원" }
    ]
  };

  if (!target || !position || !violenceType || !status) return guide;

  // =================================================================================
  // 1. TEACHER PATH (School Officials) - Keep existing enhanced logic
  // =================================================================================
  if (target === 'teacher') {
    guide.contacts = [
      { name: "학교전담경찰관(SPO)", phone: "관할 경찰서", desc: "사안 조사 및 법률 자문, 전담기구 위원" },
      { name: "교육지원청 학교폭력지원센터", phone: "지역별 번호", desc: "사안 처리 컨설팅, 법률 지원, 화해분쟁조정" }
    ];

    if (position === 'victim') { // 피해 학생 보호/지원
      guide.title = "피해 관련 학생 보호 및 지원";
      guide.summary = "피해 학생의 신체적·정신적 안전 확보가 최우선입니다. 보호자에게 신속히 연락하되 불안감을 주지 않도록 유의하세요.";
      
      if (status === 'pre-report') {
        guide.actions = [
          "피해 학생의 부상 여부를 확인하고 필요 시 즉시 보건실이나 병원으로 이송하세요.",
          "성사안의 경우, 피해 학생의 의사와 무관하게 반드시 경찰(112)에 즉시 신고해야 합니다.",
          "피해 학생이 가해 학생과의 분리를 원하는지 확인하고 '분리 의사 확인서'를 받으세요.",
          "비밀 유지를 약속하여 학생이 안심하고 진술할 수 있는 환경을 조성하세요."
        ];
      } else if (status === 'investigation') {
        guide.actions = [
          "긴급 보호 조치(1호, 2호, 6호)가 필요한지 파악하고 학교장에게 요청하세요.",
          "피해 학생 전담 조력인(교육청 지원) 제도를 안내하여 법률/상담 지원을 받도록 하세요.",
          "조사 과정에서 2차 피해가 발생하지 않도록 가해 학생과의 동선을 철저히 분리하세요."
        ];
      } else { // post-decision
        guide.actions = [
          "심의위원회 조치 결과(보호조치)를 학생과 보호자에게 상세히 안내하세요.",
          "치료비 등 비용 발생 시 학교안전공제회 청구 절차를 안내해 주세요.",
          "학급 복귀 후 따돌림 등 추가 피해가 없는지 지속적으로 모니터링하세요."
        ];
      }
    } else if (position === 'perpetrator') { // 가해 학생 선도/지도
      guide.title = "가해 관련 학생 지도 및 선도";
      guide.summary = "낙인 효과를 방지하되, 학생이 자신의 행동에 책임을 지고 반성할 수 있도록 교육적으로 지도해야 합니다.";

      if (status === 'pre-report') {
        guide.actions = [
          "감정적인 질책보다는 객관적인 사실 확인에 집중하세요. (육하원칙에 따른 확인서 작성)",
          "사안이 중대하거나 긴급한 경우 학교장 긴급조치(출석정지 등) 가능성을 검토하세요.",
          "보호자에게 사안을 통보하고, 학생이 심리적으로 불안해할 경우 Wee클래스 상담을 연계하세요."
        ];
      } else if (status === 'investigation') {
        guide.actions = [
          "가해 관련 학생이 조사 과정에서 방어권을 행사할 수 있음을 보호자에게 안내하세요.",
          "접촉, 협박, 보복행위 금지(2호 조치)를 위반할 경우 가중 조치될 수 있음을 강력히 경고하세요.",
          "학교장 자체해결 요건에 해당하더라도, 이를 강요하거나 종용해서는 안 됩니다."
        ];
      } else { // post-decision
        guide.actions = [
          "조치 사항(봉사, 특별교육 등)을 기한 내에 이행하도록 관리하고 미이행 시 교육청에 보고하세요.",
          "4호 이상 조치 시 생활기록부 기재 및 졸업 후 보존/삭제 기준을 정확히 안내하세요.",
          "학생이 진심으로 반성하고 관계 회복 의지가 있다면 관계회복 프로그램을 주선하세요."
        ];
      }
    } else if (position === 'witness') { // 행정 절차
      guide.title = "학교폭력 사안 처리 절차 (행정)";
      guide.summary = "법령과 지침에 따른 공정하고 신속한 절차 진행이 필수적입니다. 절차적 하자가 없도록 유의하세요.";

      if (status === 'pre-report') {
        guide.actions = [
          "사안 인지 후 48시간 이내에 교육지원청에 '사안접수 보고서'를 제출해야 합니다.",
          "전담기구를 소집하여 사안 접수 및 보호/가해 학생 분리 여부를 결정하세요.",
          "성범죄, 집단폭력 등 중대 사안은 SPO와 협력하여 초기 대응을 강화하세요."
        ];
      } else if (status === 'investigation') {
        guide.actions = [
          "전담 조사관의 학교 방문 일정 조율 및 조사 공간(독립된 장소)을 확보하세요.",
          "관련 학생 및 보호자 면담 시 조사관에게 필요한 자료(확인서, 증거자료 등)를 제공하세요.",
          "전담기구 심의를 통해 '학교장 자체해결' 요건(2주 미만 진단, 재산피해 복구 등 4가지) 충족 여부를 판단하세요."
        ];
      } else { // post-decision
        guide.actions = [
          "조치 결정 통보서를 수령하는 즉시 내부 결재를 득하고 대장에 기록하세요.",
          "생활기록부 기재 시점 및 유보 조건을 확인하여 정확하게 입력하세요 (나이스 처리).",
          "행정심판/소송 제기 시 교육청의 법률 지원 절차에 따라 대응하세요."
        ];
      }
    }

    guide.legalBasis = "학교폭력예방 및 대책에 관한 법률 제11조의4(업무 담당자 지원 및 면책) 및 제14조(전담기구)";
    
    if (violenceType === 'sexual') {
      guide.actions.unshift("🚨 [필독] 성사안은 학교장 자체해결이 불가하며, 반드시 수사기관 신고 및 심의위원회 개최가 원칙입니다.");
    }
    if (violenceType === 'cyber') {
      guide.actions.push("사이버 폭력 증거(URL, 캡처)는 삭제되기 쉬우므로, '사이버폭력 피해자 지원 센터' 등을 통해 채증을 지원받으세요.");
    }

    return guide;
  }

  // =================================================================================
  // 2. STUDENT & PARENT PATH
  // =================================================================================
  
  // --- 2.1 VICTIM (피해 학생/학부모) ---
  if (position === 'victim') {
    guide.contacts.push({ name: "푸른나무재단", phone: "1588-9128", desc: "학교폭력 상담 및 화해 중재" });
    if (violenceType === 'sexual') {
      guide.contacts.unshift({ name: "해바라기센터", phone: "1899-3075", desc: "성폭력 피해 통합 지원(수사/의료/상담)" });
    }

    // Step 1: Pre-report
    if (status === 'pre-report') {
      guide.title = "피해 사실 인지 및 신고 준비";
      guide.summary = "두려워하지 마세요. 당신의 잘못이 아닙니다. 지금 가장 중요한 것은 '증거 확보'와 '안전한 보호'입니다.";
      guide.actions = [
        "117(학교폭력신고센터) 또는 학교 선생님(담임/상담)에게 피해 사실을 알리세요. 익명 상담도 가능합니다.",
        "신체적 상처가 있다면 즉시 병원에 가서 '상해 진단서'를 발급받으세요. (학교폭력 관련성 언급 필수)",
        "협박 문자, SNS 게시물, 녹음 파일 등 증거 자료를 삭제하지 말고 캡처/저장하세요.",
        "가해 학생과 마주치는 것이 두렵다면 학교 측에 '분리 조치'를 즉시 요청할 수 있습니다."
      ];
      if (target === 'parent') {
        guide.actions.unshift("자녀에게 '네 잘못이 아니야, 엄마/아빠가 해결해줄게'라고 안심시켜 주세요.");
        guide.actions.push("감정적인 대응(직접 가해학생 접촉)은 자제하고, 학교 절차를 따르는 것이 자녀에게 유리합니다.");
      }
    } 
    // Step 2: Investigation
    else if (status === 'investigation') {
      guide.title = "사안 조사 및 심의 대기";
      guide.summary = "조사 과정에서 피해 사실을 명확히 진술하는 것이 중요합니다. 학교장 자체해결 요건에 동의하지 않으면 심의위원회가 열립니다.";
      guide.actions = [
        "확인서 작성 시 '언제, 어디서, 누가, 어떻게, 왜' 육하원칙에 따라 구체적이고 일관되게 작성하세요.",
        "심리적 불안이 심할 경우 '긴급 보호 조치'(심리상담, 일시보호 등)를 학교장에게 요청하세요.",
        "전담 조사관 면담 시 신뢰할 수 있는 보호자나 선생님의 동석을 요청할 수 있습니다.",
        "가해 학생 측에서 화해를 요청할 경우, 원치 않으면 거절할 수 있습니다. 무리한 합의 종용은 거부하세요."
      ];
      guide.legalBasis = "법률 제16조(피해학생의 보호) 및 제16조의2(장애학생의 보호)";
    } 
    // Step 3: Post-decision
    else { // post-decision
      guide.title = "조치 결과 확인 및 사후 관리";
      guide.summary = "결과에 대한 불복 절차가 보장되어 있으며, 치료비 지원 및 일상 회복을 위한 권리를 행사할 수 있습니다.";
      guide.actions = [
        "조치 결과에 이의가 있다면 통보받은 날로부터 90일 이내에 '행정심판'을 청구할 수 있습니다.",
        "신체적·정신적 치료비는 '학교안전공제회'를 통해 우선 지원받고 추후 구상권을 청구할 수 있습니다.",
        "가해 학생이 조치(접촉 금지 등)를 위반하거나 보복할 경우, 즉시 학교에 알리고 가중 처벌을 요구하세요.",
        "민사 소송 등 법적 대응이 필요한 경우 대한법률구조공단(132)의 무료 법률 구조를 신청해보세요."
      ];
    }
  }

  // --- 2.2 PERPETRATOR (가해 지목 학생/학부모) ---
  else if (position === 'perpetrator') {
    guide.contacts.push({ name: "청소년상담복지센터", phone: "1388", desc: "청소년 심리 상담 및 선도 프로그램" });

    // Step 1: Pre-report
    if (status === 'pre-report') {
      guide.title = "사안 인지 및 초기 대응";
      guide.summary = "가장 현명한 대처는 '솔직한 인정'과 '진심 어린 반성'입니다. 사안을 은폐하거나 축소하려 하면 더 큰 처벌을 받을 수 있습니다.";
      guide.actions = [
        "피해 학생에게 무리하게 연락하거나 찾아가는 것은 '2차 가해'로 간주되어 가중 처벌될 수 있습니다. 절대 삼가세요.",
        "사실관계를 객관적으로 정리해 보세요. 억울한 부분이 있다면 증거(메시지, 목격자)를 준비해야 합니다.",
        "본인의 행동이 상대방에게 어떤 상처를 주었는지 깊이 생각해보고, 반성하는 태도를 갖는 것이 중요합니다."
      ];
      if (target === 'parent') {
        guide.actions.unshift("자녀를 무조건 감싸거나 피해 학생을 비난하는 것은 사태를 악화시킵니다.");
      }
    } 
    // Step 2: Investigation
    else if (status === 'investigation') {
      guide.title = "조사 및 심의 준비";
      guide.summary = "조사에 성실히 임해야 합니다. 경미한 사안이라면 '학교장 자체해결'이 가능할 수 있으나, 4가지 요건을 모두 충족해야 합니다.";
      guide.actions = [
        "전담 조사관 조사 시 거짓 없이 사실대로 진술하세요. 진술 번복은 신뢰도를 떨어뜨립니다.",
        "학교장 자체해결 4대 요건: ①2주 미만 진단 ②재산피해 복구 ③지속성 없음 ④보복행위 아님.",
        "학교장의 긴급 조치(출석정지 등)가 내려지면 이를 성실히 이행해야 합니다.",
        "심의위원회 개최 시, 서면 사과나 봉사 활동 등 선도 조치에 대한 의지를 보여주는 것이 좋습니다."
      ];
      guide.legalBasis = "법률 제13조의2(학교장 자체해결) 및 제17조(가해학생에 대한 조치)";
    } 
    // Step 3: Post-decision
    else { // post-decision
      guide.title = "조치 이행 및 반성";
      guide.summary = "결정된 조치를 성실히 이행해야 합니다. 이를 거부하면 추가 징계나 과태료(보호자)가 부과될 수 있습니다.";
      guide.actions = [
        "서면사과, 봉사활동, 특별교육 등 처분 내용을 기한 내에 반드시 이수하고 이수증을 제출하세요.",
        "1~3호 조치(서면사과, 접촉금지, 교내봉사)는 1회에 한해 생활기록부 기재가 유보됩니다.",
        "4호 이상 조치는 졸업 후 최대 2년(심의 거쳐 삭제 가능) 또는 4년까지 생활기록부에 보존됩니다.",
        "결과에 불복할 경우 행정심판을 청구할 수 있으나, 명백한 증거 없이 무분별한 불복은 지양해야 합니다."
      ];
    }
  }

  // --- 2.3 WITNESS (목격 학생) ---
  else if (position === 'witness') {
    guide.title = "목격 및 제보";
    guide.summary = "여러분의 용기 있는 제보가 친구를 구할 수 있습니다. 신고자의 신분은 법적으로 철저히 보호됩니다.";
    guide.actions = [
      "방관자가 아닌 '방어자'가 되어주세요. '그만해'라고 말하는 작은 용기가 큰 힘이 됩니다.",
      "117 전화나 문자, 또는 학교의 '학교폭력 신고함'을 통해 익명으로 알릴 수 있습니다.",
      "선생님이나 부모님께 목격한 사실을 알리고 도움을 요청하세요.",
      "진술을 강요받거나 협박을 받는다면 즉시 학교나 경찰에 도움을 요청하세요. 비밀 누설 금지법에 의해 보호받습니다."
    ];
    guide.legalBasis = "법률 제20조(신고의무) 및 제21조(비밀누설금지 등)";
  }

  return guide;
};