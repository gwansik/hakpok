import { UserSelection, GuideContent } from '../types';

export const getGuideContent = (selection: UserSelection): GuideContent => {
  const { target, position, violenceType, status } = selection;

  // Default fallback
  const guide: GuideContent = {
    title: "맞춤형 행동 가이드",
    summary: "선택하신 상황에 맞는 기본적인 대처 방법을 안내해 드립니다.",
    actions: ["안전을 먼저 확보하세요.", "신뢰할 수 있는 사람에게 도움을 요청하세요."],
    legalBasis: "학교폭력예방 및 대책에 관한 법률",
    contacts: [
      { name: "학교폭력 신고센터", phone: "117", desc: "24시간 상담 및 신고" },
      { name: "청소년 전화", phone: "1388", desc: "심리 상담 및 위기 지원" }
    ]
  };

  if (!target || !position || !violenceType || !status) return guide;

  // =================================================================================
  // 1. TEACHER PATH (학교 관계자)
  // =================================================================================
  if (target === 'teacher') {
    guide.contacts = [
      { name: "학교전담경찰관(SPO)", phone: "관할 경찰서", desc: "사안 조사 및 법률 자문" },
      { name: "학교폭력대책심의위원회", phone: "교육지원청", desc: "사안 심의 및 조치 결정" }
    ];

    if (position === 'victim') {
      guide.title = "피해 관련 학생 보호 가이드";
      guide.summary = "피해 학생의 안전 확보와 심리적 안정을 최우선으로 하며, 2차 피해 방지에 주력해야 합니다.";
      
      if (status === 'pre-report') {
        guide.actions = [
          "성사안 인지 시 예외 없이 경찰 신고 및 해당 기관 통보 의무가 있습니다. (비밀엄수)",
          "피해 학생의 의사를 확인하여 '긴급 분리 조치(최대 3일)'를 시행할 수 있습니다.",
          "신체적 상처 확인 시 보건교사 소견서를 확보하고 병원 진료를 안내하세요."
        ];
      } else if (status === 'investigation') {
        guide.actions = [
          "전담조사관 방문 조사 시, 학생이 편안함을 느끼는 장소를 제공하고 보호자 동석 여부를 확인하세요.",
          "관련 학생들 간의 동선이 겹치지 않도록 등하교 시간 조정 및 수업 시간 분리를 관리하세요.",
          "피해 학생이 불안을 호소할 경우 위(Wee) 클래스 또는 외부 상담 기관을 즉시 연계하세요."
        ];
      } else {
        guide.actions = [
          "심의위원회 조치 결과 통보 후, 피해 학생의 학교 적응을 위한 모니터링 상담을 진행하세요.",
          "학교안전공제회 치료비 청구 절차를 보호자에게 상세히 안내하세요.",
          "가해 학생의 조치 이행 여부를 확인하고, 불이행 시 추가 징계 가능성을 고지하세요."
        ];
      }
    } else if (position === 'perpetrator') {
      guide.title = "가해 관련 학생 지도 가이드";
      guide.summary = "낙인보다는 교육적 선도를 목표로 하되, 절차의 공정성을 유지하며 방어권을 보장해야 합니다.";
      
      if (status === 'pre-report') {
        guide.actions = [
          "학생이 상황을 객관적으로 인지하도록 육하원칙에 따른 확인서를 받으세요. (강압적 분위기 지양)",
          "사안이 중대할 경우 학교장 긴급조치(출석정지 등) 가능성을 검토하고 보호자에게 통보하세요.",
          "접촉, 협박, 보복 행위는 2차 가해로서 가중 처벌됨을 엄중히 경고하세요."
        ];
      } else if (status === 'investigation') {
        guide.actions = [
          "학교장 자체해결 요건(2주 미만 진단, 재산피해 복구 등 4개 요건) 충족 여부를 객관적으로 판단하세요.",
          "보호자에게 전담조사관 제도와 심의 절차를 안내하고, 의견서 제출 기회를 보장하세요.",
          "조사 기간 중 섣부른 화해 종용은 2차 가해가 될 수 있으니 주의하세요."
        ];
      } else {
        guide.actions = [
          "조치 사항(봉사, 특별교육)을 기한 내 이행하도록 지도하고 결과 보고서를 제출하세요.",
          "생활기록부 기재 유보(1~3호) 및 졸업 후 삭제(4호 이상) 기준을 정확히 안내하여 선도를 독려하세요.",
          "관계 회복 프로그램 참여 의사가 있는지 확인하고 중재를 지원하세요."
        ];
      }
    } else { // witness/admin
      guide.title = "사안 접수 및 행정 절차";
      guide.summary = "초기 대응의 신속성과 행정 절차의 정확성이 중요합니다. 48시간 내 보고 원칙을 준수하세요.";
      guide.actions = [
        "사안 인지 즉시 학교장에게 보고하고, 48시간 이내 교육청에 사안 접수 보고서를 제출하세요.",
        "전담기구를 구성하여 사안조사 및 학교장 자체해결 가능 여부를 심의하세요.",
        "목격 학생의 진술을 확보하되, 익명성을 철저히 보장하여 보복 두려움을 해소해주세요."
      ];
    }
    return guide;
  }

  // =================================================================================
  // 2. STUDENT & PARENT PATH (학생 및 학부모)
  // =================================================================================

  // -------------------------------------------------------------------------------
  // HELPER: Violence Type Specific Advice (증거 확보 및 특이사항)
  // -------------------------------------------------------------------------------
  let typeSpecificAction = "";
  let typeSpecificWarning = "";

  switch (violenceType) {
    case 'physical':
      typeSpecificAction = "🏥 [증거] 병원에서 '상해 진단서'를 발급받으세요. (일반 진단서보다 '상해'가 명시된 것이 강력함) 사건 현장 주변 CCTV 열람을 학교나 경찰에 즉시 요청하세요.";
      break;
    case 'verbal':
      typeSpecificAction = "🎤 [증거] 대화 녹음은 본인이 포함되어 있다면 상대방 동의 없이도 합법입니다. 욕설이 담긴 통화나 현장 녹음을 확보하세요. 주변 친구들의 '목격 진술서'도 중요합니다.";
      break;
    case 'cyber':
      typeSpecificAction = "📱 [증거] 절대 대화방을 나가지 마세요. 대화 내용, 날짜, 시간, 상대방 프로필이 다 나오도록 스크롤 캡처하세요. 게시글은 삭제될 수 있으니 발견 즉시 PDF로 저장하거나 촬영하세요.";
      break;
    case 'bullying':
      typeSpecificAction = "📓 [증거] '피해 일지'를 작성하세요. 몇 월 며칠, 어디서, 누가, 어떤 행동을 했는지 구체적으로 기록하면 강력한 증거가 됩니다. 등교가 너무 고통스럽다면 '가정학습' 신청을 통해 출석 인정을 받을 수 있습니다.";
      break;
    case 'extortion':
      typeSpecificAction = "💸 [증거] 계좌 이체 내역(토스/카카오페이 송금증), 돈을 요구한 메시지, 뺏긴 물건의 사진이나 영수증을 확보하세요. 현금을 줬다면 줬을 때의 상황을 구체적으로 일지에 적으세요.";
      break;
    case 'sexual':
      typeSpecificAction = "🚨 [긴급] 씻거나 옷을 갈아입지 말고 즉시 해바라기센터(1899-3075)나 경찰서로 가세요. 증거 채취가 가장 중요합니다. 이 유형은 학교장 자체해결이 불가능하며 무조건 신고해야 합니다.";
      break;
  }

  // -------------------------------------------------------------------------------
  // HELPER: Target Specific Advice (학생 vs 학부모)
  // -------------------------------------------------------------------------------
  let roleAction = "";
  if (target === 'student') {
    roleAction = "💡 혼자 해결하려 하지 마세요. 부모님이나 선생님에게 알리는 것은 '고자질'이 아니라 '자신을 지키는 권리'입니다.";
  } else {
    roleAction = "👨‍👩‍👧‍👦 자녀에게 '네 잘못이 아니야, 엄마 아빠가 끝까지 지켜줄게'라고 안심시켜 주세요. 감정적으로 가해 학생에게 직접 연락하거나 찾아가는 것은 상황을 불리하게 만드니 절대 삼가세요.";
  }

  // -------------------------------------------------------------------------------
  // LOGIC: VICTIM
  // -------------------------------------------------------------------------------
  if (position === 'victim') {
    if (violenceType === 'sexual') {
      guide.contacts.unshift({ name: "해바라기센터", phone: "1899-3075", desc: "성폭력 피해 원스톱 지원" });
    }
    guide.contacts.push({ name: "푸른나무재단", phone: "1588-9128", desc: "학교폭력 전문 상담/분쟁조정" });

    guide.title = `${target === 'parent' ? '자녀가 피해를 입었을 때' : '피해를 입었을 때'} 행동 요령`;
    guide.summary = "가장 중요한 것은 '증거 확보'와 '안전한 분리'입니다. 구체적인 행동 지침을 확인하세요.";

    if (status === 'pre-report') {
      guide.actions = [
        violenceType === 'sexual' ? "🚨 성사안은 지체 없이 경찰(112)에 신고해야 하며, 증거 보존이 최우선입니다." : "👮 학교(117) 신고 또는 전담경찰관(SPO)에게 상담을 요청하세요.",
        typeSpecificAction, // 위에서 정의한 유형별 맞춤 행동
        roleAction, // 학생/학부모별 멘트
        "학교 측에 가해 학생과의 '긴급 분리 조치(최대 3일)'를 즉시 요청할 수 있습니다."
      ];
    } else if (status === 'investigation') {
      guide.summary = "조사가 시작되었습니다. 진술의 일관성을 유지하고, 심리적 보호를 요청하세요.";
      guide.actions = [
        "진술서 작성 시 육하원칙(언제, 어디서, 누가, 무엇을, 어떻게, 왜)에 맞춰 감정보다는 '사실' 위주로 구체적으로 적으세요.",
        typeSpecificWarning || "조사 과정에서 가해 학생이 화해를 강요하거나 협박한다면 즉시 학교에 알리고 추가 징계를 요구하세요.",
        "불안감이 심할 경우, 학교 위(Wee) 클래스나 교육청 지원 심리 상담을 학교에 요청하세요.",
        target === 'parent' ? "학폭위 개최 전까지 자녀의 심리 상태를 매일 체크하고, 병원 진료 기록 등을 꾸준히 모으세요." : "조사관님 앞에서 이야기하기 떨린다면 부모님이나 선생님과 함께 조사받겠다고 말하세요."
      ];
    } else { // post-decision
      guide.actions = [
        "결과 통보서를 꼼꼼히 확인하고, 조치가 미흡하다고 판단되면 90일 이내에 행정심판을 청구할 수 있습니다.",
        "가해 학생이 '접촉 금지' 조치를 어기고 접근하거나 연락하면 즉시 증거를 남겨 학교에 신고하세요.",
        "치료비와 심리 상담 비용은 '학교안전공제회'를 통해 우선 지원받을 수 있습니다. 영수증을 꼭 챙기세요."
      ];
    }
  }

  // -------------------------------------------------------------------------------
  // LOGIC: PERPETRATOR
  // -------------------------------------------------------------------------------
  else if (position === 'perpetrator') {
    guide.contacts.push({ name: "청소년상담복지센터", phone: "1388", desc: "고민 상담 및 선도 프로그램" });
    
    guide.title = `${target === 'parent' ? '자녀가 가해 지목을 받았을 때' : '가해 지목을 받았을 때'} 대응 가이드`;
    guide.summary = "무조건적인 부인보다는 솔직한 인정과 반성이 결과에 긍정적인 영향을 미칩니다.";

    if (status === 'pre-report') {
      guide.actions = [
        "피해 학생에게 무리하게 연락하거나 찾아가는 것은 '2차 가해'로 간주되어 상황을 악화시킵니다.",
        "기억이 나지 않거나 억울한 부분이 있다면, 당시 상황을 입증할 수 있는 카톡 대화나 친구들의 증언을 확보하세요.",
        target === 'parent' ? "자녀를 무조건 감싸기보다 무슨 일이 있었는지 차분하게 들어보고, 잘못한 점은 인정하도록 지도하세요." : "친구에게 진심으로 사과하고 싶다면 선생님을 통해 의사를 전달하는 것이 안전합니다."
      ];
    } else if (status === 'investigation') {
      guide.actions = [
        "전담조사관 조사 시 거짓말을 하거나 진술을 계속 바꾸면 신뢰를 잃어 더 무거운 조치를 받을 수 있습니다.",
        "학교장 자체해결 4대 요건(2주 미만 진단, 재산피해 복구, 지속성 없음, 보복 아님)에 해당하는지 확인해보세요.",
        "반성문이나 보호자의 선도 서약서는 심의 과정에서 반성의 의지를 보여주는 중요한 자료가 됩니다."
      ];
    } else {
      guide.actions = [
        "내려진 조치(봉사, 특별교육 등)를 기한 내에 성실히 이행하지 않으면 추가 징계를 받게 됩니다.",
        "1~3호 조치(서면사과, 교내봉사 등)는 1회에 한해 생활기록부 기재가 유보되니, 이번을 기회로 삼아 행동을 개선하세요.",
        "행정심판 등 불복 절차는 명확한 증거와 사유가 있을 때 진행하는 것이 좋습니다."
      ];
    }
  }

  // -------------------------------------------------------------------------------
  // LOGIC: WITNESS
  // -------------------------------------------------------------------------------
  else if (position === 'witness') {
    guide.title = "목격자 행동 가이드";
    guide.summary = "여러분의 용기가 친구를 구할 수 있습니다. 신고자의 비밀은 법적으로 철저히 보장됩니다.";
    guide.actions = [
      "방관자가 아닌 '방어자'가 되어주세요. '하지 마'라고 말하는 작은 한마디가 상황을 바꿀 수 있습니다.",
      "직접 말리기 무섭다면, 즉시 선생님께 알리거나 117에 익명으로 문자/전화 제보를 하세요.",
      "목격 진술은 피해 학생에게 결정적인 도움이 됩니다. 전담조사관에게 본 그대로 사실만 이야기하면 됩니다."
    ];
  }

  return guide;
};